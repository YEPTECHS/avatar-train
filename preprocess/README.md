# Video Preprocessing Pipeline

This folder contains the preprocessing pipeline for video data processing. Follow the steps below to set up and run the pipeline.

## Setup Instructions

### 1. Create and Activate Conda Environment

```bash
# Create conda environment from environment.yml
conda env create -f environment.yml

# Activate the environment
conda activate muse-preprocess
```

### 2. Directory Structure
Your data directory should be organized as follows:

```
data_root/
├── dataset_name1.mp4
├── dataset_name2.mp4
└── dataset_name3.mp4
```

Each video file should:
- Be directly under the data_root directory
- Have .mp4 format
- Use the dataset name as the filename (e.g., "interview1.mp4", "speech2.mp4")

The output directory will be automatically organized as:
```
output_root/
├── frame/
│   ├── dataset_name1/
│   │   ├── 000001.png
│   │   ├── 000002.png
│   │   └── ...
│   └── dataset_name2/
├── landmarks/
│   ├── dataset_name1/
│   └── dataset_name2/
└── aligned_with_bg/
    ├── dataset_name1/
    └── dataset_name2/
```

## Usage

### 1. Navigate to the Preprocessing Directory
```bash
cd preprocess
```

### 2. Run the Pipeline
Run the preprocessing script with your data path and output path:

```bash
python run.py --data_path /path/to/your/input/directory/data_root --output_path /path/to/output/directory/output_root
```

Replace `/path/to/your/input/directory/data_root` with the directory containing your input videos and `/path/to/output/directory/output_root` with where you want the processed data to be saved.

### 3. Run Image Cropping
After running the preprocessing pipeline, run the image cropping script to create aligned face images:

```bash
python crop_image.py --data_root /path/to/output/directory/output_root
```

This script will:
- Process the frames generated in the previous step
- Detect and crop faces using the landmark data
- Create aligned face images in the `aligned_with_bg` directory
- Resize all cropped images to 256x256 pixels

Make sure to check the `output_root` path in `crop_image.py` matches your output directory from step 2.

## Pipeline Steps

The preprocessing pipeline includes the following steps:

1. Video Segmentation: Splits videos into frames
2. Audio Splitting: Extracts audio from videos
3. Audio Feature Extraction: Processes the extracted audio
4. Face Alignment and Cropping: Creates aligned face images (run separately with crop_image.py)
5. Background Removal (Optional): Can be enabled by uncommenting the relevant code in `run.py`

## Requirements

The environment includes all necessary dependencies including:
- PyTorch with CUDA support
- OpenCV
- FFmpeg
- Various audio processing libraries

For a complete list of dependencies, refer to `environment.yml`.

## Notes

- Make sure you have sufficient disk space for the output data
- The pipeline processes all videos found in the input directory
- Output directory will be created if it doesn't exist
- The cropping step requires the frames and landmarks generated by run.py
- Each video file should be named as dataset_name.mp4 and placed directly in the data_root directory
